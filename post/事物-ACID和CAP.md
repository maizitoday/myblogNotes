---
title:       "ACID，CAP，分布式事物"
subtitle:    ""
description: "CAP, ACID, 分布式事务, base理论"
date:        2019-05-21
author:      "麦子"
image:       "https://c.pxhere.com/photos/21/d4/panorama_sunset_sky_abendstimmung_clouds_dusk_mood_sun-1407861.jpg!d"
tags:        ["数据库","分布式系列", "事物"]
categories:  ["Tech" ]
---

[TOC]

**说明：截图来源视频地址https://www.bilibili.com/video/av53185872?from=search&seid=7556677055845288226**

# ACID

## 原子性

![5-22-01](/img/5-22-01.png)

## 一致性

![5-22-02](/img/5-22-02.png)

## 隔离性

![5-22-03](/img/5-22-03.png)

### 隔离级别

![5-22-07](/img/5-22-07.png)

#### 赃读

![5-22-08](/img/5-22-08.jpg)

![5-22-08-01](/img/5-22-08-01.jpg)

#### 不可重复读

![5-22-09](/img/5-22-09.jpg)

![5-22-09-01](/img/5-22-09-01.jpg)

#### 虚读(幻读)

![5-22-10](/img/5-22-10.jpg)

![5-22-10-01](/img/5-22-10-01.jpg)



## 持久性

![5-22-04](/img/5-22-04.png)

## 原子性和隔离性

![5-22-05](/img/5-22-05.png)

#  CAP理论

**原文地址：链接：https://www.jianshu.com/p/d92acee6ceb3**

![5-22-11](/img/5-22-11.jpg)

## 一致性（C:Consistency）

在分布式环境中，一致性是指数据在多个副本之间是否能够保持数据一致的特性。**在一致性的需求下，当一个系统在数据一致的状态下执行更新操作后，应该保证系统的数据仍然处于一致的状态**。例如一个将数据副本分布在不同分布式节点上的系统来说，如果对第一个节点的数据进行了更新操作并且更新成功后，其他节点上的数据也应该得到更新，并且所有用户都可以读取到其最新的值，那么这样的系统就被认为具有**强一致性**（或严格的一致性，最终一致性）。

## 可用性（A:Available）

**可用性是指系统提供的服务必须一直处于可用的状态，对于用户的每一个操作请求总是能够在有限的时间内返回结果**。“有效的时间内”是指，对于用户的一个操作请求，**系统必须能够在指定的时间（即响应时间）内返回对应的处理结果，如果超过了这个时间范围，那么系统就被认为是不可用的**。

“返回结果”是可用性的另一个非常重要的指标，它要求系统在完成对用户请求的处理后，返回一个正常的响应结果。正常的响应结果通常能够明确的反映出对请求的处理结果，即成功或失败，而不是一个让用户感到困惑的返回结果。

## 分区容错性（P:Partition Tolerance）

分区容错性约束了一个分布式系统需要具有如下特性：**分布式系统在遇到任何网络分区故障的时候，仍然需要能够保证对外提供满足一致性和可用性的服务，除非是整个网络环境都发生了故障**。

网络分区是指在分布式系统中，不同的节点分布在不同的子网络（机房或异地网络等）中，由于一些特殊的原因导致这些子网络之间出现网络不连通的状况，但各个子网络的内部网络是正常的，从而导致整个系统的网络环境被切分成了若干个孤立的区域。需要注意的是，组成一个分布式系统的每个节点的加入与退出都可以看作是一个特殊的网络分区。

由于一个分布式系统无法同时满足上面的三个需求，而只能满足其中的两项，因此在进行对CAP定理的应用的时候，需要根据业务的要求抛弃其中的一项，下表所示是抛弃CAP定理中任意一项特性的场景说明。

因此，将精力浪费在思考如何设计能满足三者的完美系统上是愚钝的，应该根据应用场景进行适当取舍。

## CP和AP

**CP：**当一个请求过来获取数据的时候， 需要等待所有节点之间的数据同步完成后， 才返回这个请求数据。

**如： ZooKeeper，Redis**

**AP：**当一个请求过来获取数据的时候， 就直接返回结果数据给他。

**CA 传统Oracle数据库**



# BASE理论

转载：https://www.jianshu.com/p/f6157118e54b

BASE全称：**Basically Available(基本可用)**，**Soft state（软状态）**,和 **Eventually consistent（最终一致性）**。

CAP 不可能同时满足，而分区容错是对于分布式系统而言又是必须的。

Base 理论是对 CAP 中一致性和可用性权衡的结果，是基于 CAP 定理逐步演化而来的。其核心思想是：既是无法做到**强一致性（Strong consistency）**，但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到**最终一致性（Eventual consistency）**。



## 1. Basically Available(基本可用)

什么是基本可用呢？假设系统，出现了不可预知的故障，但还是能用，相比较正常的系统而言：

响应时间上的损失：正常情况下的一个请求 0.5 秒即返回给用户结果，而基本可用的请求可以在 1 秒作用返回结果。

功能上的损失：在一个电商网站上，正常情况下，用户可以顺利完成每一笔订单，但是到了大促期间，为了保护购物系统的稳定性，可以关闭一些不重要的功能或者部分消费者可能会被引导到一个降级页面。



## 2. Soft state（软状态）

什么是软状态呢？相对于原子性而言，要求多个节点的数据副本都是一致的，这是一种 “硬状态”。

软状态指的是：允许系统中的数据存在中间状态，并认为该状态不影响系统的整体可用性，即允许系统在多个不同节点的数据副本存在数据延时。



## 3. Eventually consistent（最终一致性）

系统能够保证在没有其他新的更新操作的情况下，数据最终一定能够达到一致的状态，因此所有客户端对系统的数据访问最终都能够获取到最新的值。

上面说软状态，然后不可能一直是软状态，必须有个时间期限。在期限过后，应当保证所有副本保持数据一致性。从而达到数据的最终一致性。这个时间期限取决于网络延时，系统负载，数据复制方案设计等等因素。



# 分布式事物

## 分布式事物的产生

![5-22-12](/img/5-22-12.jpg)

## 分布式事物理论

![5-22-13](/img/5-22-13.jpg)

## 分布式解决方案

**原文转载地址：https://www.cnblogs.com/dousnl/p/9772605.html**

![5-22-14](/img/5-22-14.png)

### XA规范

XA协议比较简单，而且一旦商业数据库实现了XA协议，使用分布式事务的成本也比较低。但是，XA也有致命的缺点，那就是性能不理想，特别是在交易下单链路，往往并发量很高，XA无法满足高并发场景。XA目前在商业数据库支持的比较理想，在mysql数据库中支持的不太理想，mysql的XA实现，没有记录prepare阶段日志，主备切换回导致主库与备库数据不一致。许多nosql也没有支持XA，这让XA的应用场景变得非常狭隘。**JTA就是这种**

### 2PC

#### 消息事务+最终一致性

所谓的消息事务就是基于消息中间件的两阶段提交，本质上是对消息中间件的一种特殊利用，它是将本地事务和发消息放在了一个分布式事务里，保证要么本地操作成功成功并且对外发消息成功，要么两者都失败，开源的RocketMQ就支持这一特性.

该方案采用最终一致的，牺牲了一致性，换来了性能的大幅度提升。存在造成数据不一致的风险

#### TCC编程模式

所谓的TCC编程模式，也是两阶段提交的一个变种。TCC提供了一个编程框架，将整个业务逻辑分为三块：Try、Confirm和Cancel三个操作。以在线下单为例，Try阶段会去扣库存，Confirm阶段则是去更新订单状态，如果更新订单失败，则进入Cancel阶段，会去恢复库存。总之，TCC就是通过代码人为实现了两阶段提交，不同的业务场景所写的代码都不一样，复杂度也不一样，因此，这种模式并不能很好地被复用。

![5-22-15](/img/5-22-15.png)



### TX-LCN分布式事务框架(常用这种)

官网地址：https://www.txlcn.org/zh-cn/

LCN分布式事务框架的核心功能是对本地事务的协调控制，框架本身并不创建事务，只是对本地事务做协调控制。因此该框架与其他第三方的框架兼容性强，支持所有的关系型数据库事务，支持多数据源，支持与第三方数据库框架一块使用（例如 sharding-jdbc），**在使用框架的时候只需要添加分布式事务的注解即可**，对业务的侵入性低。LCN框架主要是为微服务框架提供分布式事务的支持，在微服务框架上做了进一步的事务机制优化，在一些负载场景上LCN事务机制要比本地事务机制的性能更好。

好文：https://blog.csdn.net/qq_28341873/article/details/79789054