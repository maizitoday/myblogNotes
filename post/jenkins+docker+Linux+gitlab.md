---
title:       "jenkins+docker+Linux+gitlab"
subtitle:    ""
description: ""
date:        2019-04-09
author: Â  Â   "éº¦å­"
image:       "https://img.zhaohuabing.com/post-bg-2015.jpg"
tags:        ["jenkins", "gitlab","æŒç»­é›†æˆ","æœåŠ¡éƒ¨ç½²"]
categories:  ["Tech" ]
---

## 

# Jenkinsè‡ªåŠ¨éƒ¨ç½²æ­¥éª¤

jenkinsåœ¨macä¸­å®‰è£…ï¼Œ dockeré‡Œé¢åˆ†åˆ«å®‰è£…äº†linuxï¼Œä½œä¸ºæœåŠ¡å™¨ï¼Œæ‹‰å–gitlabä½œä¸ºç§äººä»£ç åº“ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬åº”è¯¥è¦æ˜Žç™½Jenkinsçš„åŽŸç†ï¼Œä»–æ˜¯è¿™æ ·çš„

a. é€šè¿‡é…ç½®gitlabï¼Œè®©æˆ‘ä»¬å¯ä»¥æŠŠä»£ç å­˜å…¥åˆ°ä»“åº“ã€‚ 

b. é€šè¿‡é…ç½®jenkinså’Œgitlabçš„å…³è”ï¼Œè®©jenkinså¯ä»¥é€šè¿‡SSHæ¥èŽ·å–gitlabçš„ä»£ç åˆ°jenkinsçš„æœºå­ä¸Šã€‚

c. é€šè¿‡é…ç½®jenkinså’ŒlinuxæœåŠ¡å™¨ï¼Œé€šè¿‡SSHåè®®ï¼Œå¯ä»¥æŠŠjenkinsä¸­æ‰“åŒ…å¥½çš„åŒ…ï¼Œä¼ è¾“åˆ°æœåŠ¡å™¨ä¸Šé¢ã€‚

d. åœ¨jenkinsä¸­é€šè¿‡è®¾ç½®å¥½ä¸Šä¼ å¥½åŒ…åŽï¼Œæ‰§è¡ŒæœåŠ¡å™¨ä¸­å›ºå®šçš„shellè„šæœ¬ï¼Œç„¶åŽè¿›è¡Œå¯¹åŒ…çš„è¿è¡Œå’Œå‘å¸ƒå¤„ç†ã€‚ 

Jenkinsé¦–å…ˆä¼šé€šè¿‡Gitå°†ä»£ç cloneåˆ°æœ¬åœ°ï¼Œç„¶åŽæ‰§è¡Œåœ¨Buildä¸­æŒ‡å®šçš„  pom.xmlæ–‡ä»¶å’ŒæŒ‡å®šçš„å‘½ä»¤ï¼Œæ‰“åŒ…åŽï¼Œç„¶åŽé€šè¿‡SSHåè®®ï¼Œä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œç„¶åŽåœ¨æœåŠ¡å™¨ä¸Šè¿›è¡Œè„šæœ¬å‘å¸ƒã€‚ 

ä¸‹é¢å¼€å§‹æŒ‰ç…§è¿™ä¸ªæ­¥éª¤æ¥è¿›è¡Œå¤„ç†ï¼Œä¸»è¦è¯´å‡ºéœ€è¦æ³¨æ„çš„åœ°æ–¹ã€‚ 



## ç¬¬ä¸€æ­¥ï¼š dockeræ‹‰å–gitlab

éœ€è¦æ³¨æ„å¦‚æžœç›´æŽ¥è¿›è¡Œå®‰è£…ï¼Œåœ¨æ‰“å¼€çš„gitlabæ—¶å€™ï¼Œå‘çŽ°ï¼š

![4-9-10](/img/4-9-10.png)

 è¿™ä¸ªåœ°æ–¹ä¸ä¼šæ˜¯ä½ çš„ipåœ°å€ï¼Œä¼šæ˜¯ä½ å®¹å™¨çš„idï¼Œè¿™æ˜¯å¾ˆä¸æ–¹ä¾¿çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å¯åŠ¨çš„æ—¶å€™éœ€è¦åŠ å…¥hostnameæŒ‡å®šï¼Œå¦‚ä¸‹ï¼š

```yaml
docker run -itd  -p 8443:443  -p 8081:80  -p 2222:2222   
                 -p 9090:9090  --name gitlab  --hostname 192.168.70.102  
                 --privileged=true   gitlab/gitlab-ce:latest
```

åŒæ—¶ï¼Œæˆ‘è¿™è¾¹æŠŠSSHçš„é»˜è®¤ç«¯å£ä¿®æ”¹ä¸ºäº†2222ï¼Œè¿™ä¸ªä¿®æ”¹éœ€è¦åˆ°å¯¹åº”çš„é…ç½®é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä¸ä¿®æ”¹ï¼Œæˆ‘è¿™è¾¹ä¸»è¦æ˜¯æ€•ç«¯å£å†²çªã€‚

```yaml
$ docker run -d \
--hostname 10.10.1.70 \ Â  Â # æŒ‡å®šå®¹å™¨åŸŸå,æœªçŸ¥åŠŸèƒ½:åˆ›å»ºé•œåƒä»“åº“çš„æ—¶å€™ä½¿ç”¨åˆ°
-p 8443:443 \ # å°†å®¹å™¨å†…443ç«¯å£æ˜ å°„åˆ°ä¸»æœº8443,æä¾›httpsæœåŠ¡
-p 8080:80 \Â # å°†å®¹å™¨å†…80ç«¯å£æ˜ å°„åˆ°ä¸»æœº8080,æä¾›httpæœåŠ¡
-p 2222:22 \Â # å°†å®¹å™¨å†…22ç«¯å£æ˜ å°„åˆ°ä¸»æœº2222,æä¾›sshæœåŠ¡
-p 9090:9090 \Â  # å°†å®¹å™¨å†…9090ç«¯å£æ˜ å°„åˆ°ä¸»æœº9090,æä¾›prometheusæœåŠ¡
--name gitlab \ Â # æŒ‡å®šå®¹å™¨åç§°

-v /docker_data/gitlab_home/config:/etc/gitlab \Â  # å°†æœ¬åœ°/home/gitlab/configæŒ‚è½½åˆ°å®¹å™¨å†…/etc/gitlab

-v /docker_data/gitlab_home/logs:/var/log/gitlab \ # å°†æœ¬åœ°/home/gitlab/logsæŒ‚è½½åˆ°å®¹å™¨å†…/var/log/gitlab

-v /docker_data/gitlab_home/data:/var/opt/gitlab \Â # å°†æœ¬åœ°/home/gitlab/dataæŒ‚è½½åˆ°å®¹å™¨å†…/var/opt/gitlab

gitlab/gitlab-ce:latest Â # é•œåƒåç§°:ç‰ˆæœ¬
```

åŒæ—¶æˆ‘å¦‚æžœæŒ‰ç…§ä¸Šé¢çš„è¿›è¡Œå¯åŠ¨ï¼Œå‘çŽ°åªè¦åŠ å…¥dataè¿™ä¸ªæ•°åŠµï¼Œæ€»æ˜¯æ— æ³•å¯åŠ¨æˆåŠŸï¼ŒæŸ¥çœ‹è¿™ä¸ªæœ¬åœ°æ–‡ä»¶å¤¹æƒé™ä¹Ÿæ˜¯å¤Ÿçš„ï¼Œå®žåœ¨ä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŽŸå› ï¼Œæ€€ç–‘è¿˜æ˜¯æƒé™é—®é¢˜å¯¼è‡´ï¼Œæˆ‘çš„å®¿ä¸»æœºæ˜¯macï¼Œæ— å¥ˆæˆ‘å°±ç”¨ä¸Šé¢è¯­å¥å¯åŠ¨ï¼Œåªæ˜¯ä¸€ä¸ªæµ‹è¯•ã€‚

**ä¸Šé¢è¿™ä¸€æ­¥ï¼Œå°±å·²ç»æŠŠæœ¬åœ°çš„ä»£ç å’Œgitlabè¿›è¡Œå…³è”äº†èµ·æ¥**



## ç¬¬äºŒæ­¥ï¼š  å®‰è£…å¥½jenkins

å®‰è£…å¥½jenkinsï¼ŒæŸ¥çœ‹ç½‘ä¸Šå…¶ä»–æ–‡ç« ï¼Œå°±å¯ä»¥å®‰è£…å¥½ï¼Œéœ€è¦æ³¨æ„è®°å¾—å®‰è£…ä¸¤ä¸ªä¸»è¦çš„æ’ä»¶ï¼Œ

 a.  Publish over SSH  ç”¨äºŽä¸Šä¼ åŒ…åˆ°linuxæœåŠ¡å™¨ã€‚ï¼ˆä¸‹é¢åœ¨è¯´è¿™ä¸ªæ’ä»¶çš„é…ç½®ï¼‰

b.  [Maven Integration plugin](https://wiki.jenkins.io/display/JENKINS/Maven+Project+Plugin) è¿™ä¸ªæ’ä»¶ç”¨æˆ·jenkinsåˆ›å»ºæ—¶å€™ï¼Œåˆ›å»ºmavenä»»åŠ¡ï¼Œå¯¹åº”mavené¡¹ç›®å¤„ç†ã€‚



## ç¬¬ä¸‰æ­¥ï¼š jenkins,gitlabä»£ç å…³è”

![4-9-11](/img/4-9-11.png)

è¿™ä¸€æ­¥å°±æ˜¯ä¸¤ä¸ªè¿›è¡Œäº†å…³è”ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å¡«å†™SSH key ç§é’¥çš„æ—¶å€™ï¼Œè¿™ä¸ªåœ°æ–¹å¡«å†™çš„äº‹ç§é’¥ï¼Œgitlabé‚£è¾¹å¡«å†™çš„äº‹å…¬é’¥ï¼ŒåŒæ—¶ï¼Œéœ€è¦åœ¨jenkinsçš„è¿™å°æœºå­ä¸Šç”Ÿæˆå…¬é’¥å’Œç§é’¥ã€‚

ç»è¿‡è¿™ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬å°±æŠŠgitlabå’Œjenkinsè¿›è¡Œäº†è”ç³»ï¼Œé€šè¿‡è¿™ä¸ªjenkinsæ¥cloneæˆ‘ä»¬çš„æäº¤åˆ°gitlabä¸Šé¢çš„ä»£ç ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦é…ç½®jenkinsçš„ä¸€äº›jdkå’Œmavenè¿™æ ·çš„åŸºç¡€é…ç½®ï¼Œç”¨äºŽjenkinså¯¹ä»£ç çš„æ‰“åŒ…å¤„ç†ã€‚ 



## ç¬¬å››æ­¥  gitlab,jenkinsæž„å»ºè§¦å‘å™¨

![4-9-12](/img/4-9-12.png)

å›¾ä¸Šç”»çº¿çš„åœ°æ–¹ï¼Œéœ€è¦åœ¨gitlabä¸­ï¼Œç‚¹å‡»ä½ éœ€è¦å…³è”çš„é¡¹ç›®ï¼Œã€‹è®¾ç½®ã€‹é›†æˆ

![4-9-13](/img/4-9-13.png)

åœ¨è¿™ä¸ªåœ°æ–¹å¡«å…¥ï¼Œ æˆ‘è¿™è¾¹é€‰æ‹©çš„è§¦å‘å½¢å¼æ˜¯ï¼Œæäº¤ä»£ç å°±è‡ªåŠ¨æž„å»ºä¸€æ¬¡ã€‚ å¡«å†™æˆåŠŸåŽéœ€è¦æ³¨æ„ï¼Œåœ¨ä¸‹æ”¾çš„ SSL verification è¿™ä¸ªé€‰é¡¹åŽ»æŽ‰ï¼Œ ä¸è¿›è¡ŒSSLéªŒè¯ï¼Œ ç„¶åŽç‚¹å‡»  add  webhook 

![4-9-14](/img/4-9-14.png)

ç„¶åŽä¸‹é¢ä¼šç”Ÿæˆä¸€ä¸ª é€‰é¡¹ï¼Œ ç„¶åŽé€‰æ‹©ç¬¬ä¸€ä¸ª push eventsï¼Œæ¨¡æ‹ŸæŽ¨é€ï¼Œå¦‚æžœåœ¨è¿™ä¸ªé¡µé¢æœ€ä¸Šé¢æ˜¾ç¤º

![4-9-15](/img/4-9-15.png)

æ˜¾ç¤º200ï¼Œ è¡¨ç¤ºæ¨¡æ‹ŸæŽ¨é€æˆåŠŸï¼Œé‚£ä¸ªjenkinså°±åœ¨è¿›è¡Œæž„å»ºäº†ã€‚ 

éœ€è¦æ³¨æ„çš„å¦‚æžœæŠ¥é”™äº†ï¼Œ æœ‰å¯èƒ½æ˜¯gitlabä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œ ä¸å…è®¸æœ¬åœ°ç½‘ç»œä½¿ç”¨è¿™ä¸ªé’©å­ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦è®¾ç½®å…è®¸æœ¬åœ°ç½‘ç»œä½¿ç”¨ï¼Œ å…·ä½“è®¾ç½®è·¯å¾„ï¼Œ æˆ‘ä»¬ç”¨rootè´¦å·ç™»å½•ï¼Œç„¶åŽç‚¹å‡» ç®¡ç†ä¸­å¿ƒï¼ˆå°±æ˜¯ä¸€ä¸ªå°ðŸ”§çš„å›¾æ ‡ï¼‰ï¼Œç„¶åŽè¿›å…¥è®¾ç½®ï¼Œç„¶åŽé€‰æ‹©ç½‘ç»œï¼Œ å¦‚ä¸‹ï¼š

![4-9-16](/img/4-9-16.png)

è¿™æ ·å°±å¯ä»¥äº†ã€‚



## ç¬¬äº”æ­¥ï¼š jenkinså’ŒLinuxå…³è”

![4-9-17](/img/4-9-17.png)

è¿™ä¸ªåœ°æ–¹å°±æ˜¯æ‰“é€šäº†ï¼Œ jenkinså’Œlinuxä¹‹é—´çš„é€šé“ï¼Œ åœ¨è¿™é‡Œéœ€è¦ç¡®å®šï¼Œ ä½ è¿œç¨‹çš„Linuxå·²ç»å¼€å¯äº†SSH serviceï¼Œä½ å¯ä»¥æŸ¥çœ‹è¿›ç¨‹æ˜¯å¦ ps -elf | grep ssh æ˜¯å¦æœ‰ï¼Œ è¿™ä¸ªåœ°æ–¹é…ç½®ï¼Œå¯ä»¥æœ‰åœ°æ–¹ä¿®æ”¹é»˜è®¤ç«¯å£ã€‚ éœ€è¦æ³¨æ„è¿™ä¸ªåœ°æ–¹çš„remote directory æ˜¯ä½ Linuxçš„åœ°å€ï¼Œå’Œä¸‹é¢çš„å›¾ä¸­çš„ Remote directory æ˜¯é›†æˆå…³ç³»ã€‚ è¿™é‡Œæˆ‘ç›´æŽ¥ä½¿ç”¨äº†è´¦å·å’Œå¯†ç ç™»å½•ï¼Œæµ‹è¯•å¦‚æžœçŽ°å®žsuccessè¡¨ç¤ºå’ŒLinuxå…³è”æˆåŠŸï¼Œ è¿™ä¸ªåœ°æ–¹ä¹Ÿå°±æ˜¯æŠŠä½ çš„jaråŒ…é€šè¿‡SSHå‘é€åˆ°LinuxæœåŠ¡å™¨çš„åœ°æ–¹ã€‚



##  ç¬¬å…­æ­¥ï¼šjarå‘é€åˆ°æœåŠ¡å™¨ï¼Œæ‰§è¡Œè„šæœ¬

![4-9-18](/img/4-9-18.png)



å›¾ä¸­

Source filesï¼š  è¿™ä¸ªåœ°å€çš„æ€Žä¹ˆå†™ï¼Œå¯ä»¥æŸ¥çœ‹ä½ æž„å»ºæ—¶å€™çš„æ—¥å¿—ï¼Œ æŸ¥çœ‹å¦‚ä¸‹ä¸¤å¥è¯ï¼Œç„¶åŽæŠŠä¸åŒçš„æ‰¾ä¸å‡ºæ¥ï¼Œå°±æ˜¯è¿™ä¸ªåœ°å€äº†ï¼Œ åº”ä¸ºè¿™ä¸ªåŽŸæ–‡ä»¶çš„åœ°å€æ˜¯ç›¸å¯¹äºŽjenkins homeçš„è·¯å¾„çš„ã€‚ 

09:51:48 æž„å»ºä¸­ åœ¨å·¥ä½œç©ºé—´ /Users/Shared/Jenkins/Home/workspace/SpringBootJenkins ä¸­

09:51:59 [INFO] Building jar: /Users/Shared/Jenkins/Home/workspace/SpringBootJenkins/target/springbootdemoweb-0.0.1-SNAPSHOT.jar

Remove prefixï¼š è¿™ä¸ªå°±æ˜¯åŽ»é™¤å‰é¢ä¸éœ€è¦çš„  

Remote directoryï¼š è¿™ä¸ªæ˜¯é›†æˆä¸Šé¢é‚£ä¸ªå›¾çš„åœ°å€ï¼Œç›¸å½“äºŽæŠŠè¿™ä¸ªjaråŒ…ä¸Šä¼ åˆ°linuxçš„å…·ä½“çš„ä½ç½®ã€‚

Exec commandï¼š  è¿™ä¸ªå°±æ˜¯æ‰§è¡Œshellè„šæœ¬äº†ã€‚ è¿™é‡Œéƒ½æ˜¯ç›¸å¯¹äºŽlinuxæœåŠ¡å™¨å†™çš„ï¼Œéœ€è¦linuxä¸Šé¢è¿™ä¸ªç›®å½•æœ‰è¿™ä¸ªshellè„šæœ¬ã€‚

æ³¨æ„ï¼šä¸è¦åŠ å…¥ /  , æˆ‘è¿™è¾¹åŠ å…¥ / åŽï¼ŒåŒ…æ€»æ˜¯ä¸èƒ½ä¸Šä¼ æˆåŠŸã€‚   



## æž„å»ºæˆåŠŸæ—¥å¿—

```yaml
09:52:01 [JENKINS] Archiving /Users/Shared/Jenkins/Home/workspace/SpringBootJenkins/target/springbootdemoweb-0.0.1-SNAPSHOT.jar to com.example/springbootdemoweb/0.0.1-SNAPSHOT/springbootdemoweb-0.0.1-SNAPSHOT.jar
09:52:02 SSH: Connecting from host [localhost]
09:52:02 SSH: Connecting with configuration [192.168.70.102] ...
09:52:02 channel stopped
09:52:03 SSH: EXEC: STDOUT/STDERR from command [cd  /var/dev/springboot
09:52:03 sh ./springbootshell.sh restart] ...
09:52:03 >>> api PID = 1084 begin kill 1084 <<<
09:52:05 >>> springbootdemoweb-0.0.1-SNAPSHOT.jar is not running <<<
09:52:05 >>> start springbootdemoweb-0.0.1-SNAPSHOT.jar successed PID=1140 <<<
09:52:05 SSH: EXEC: completed after 2,425 ms
09:52:05 SSH: Disconnecting configuration [192.168.70.102] ...
09:52:05 SSH: Transferred 1 file(s)
```

è¿™æ ·ï¼Œä½ æ¯æ¬¡æäº¤ä»£ç ï¼Œç„¶åŽjenkinsæ‹‰å–ä»£ç ï¼Œç„¶åŽè‡ªåŠ¨éƒ¨ç½²ï¼Œå‘åŒ…åˆ°Linuxï¼Œç„¶åŽåœ¨è‡ªåŠ¨å¯åŠ¨shellè„šæœ¬ï¼Œè¿™æ ·å°±æœåŠ¡åŒ…å°±å‘å¸ƒäº†ã€‚ 